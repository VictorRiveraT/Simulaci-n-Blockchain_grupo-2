<!doctype html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blockchain Simulator ‚Äî ECDSA & PoW</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/elliptic/6.5.4/elliptic.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <script>
    const EC = elliptic.ec;
    const ec = new EC('secp256k1');

    // --- INICIO C√ìDIGO WEBSOCKETS ---
    const socket = io();

    socket.on('connect', () => {
        console.log("‚úÖ Conectado en Tiempo Real");
        setBadge(true, '(EN VIVO)');
    });

    // Cuando llega una nueva transacci√≥n, actualizamos la tabla mempool
    socket.on('actualizacion_mempool', (data) => {
        console.log("üì© Evento: " + data.msg);
        document.getElementById('btnShowMempool').click();
    });

    // Cuando se mina un bloque, actualizamos TODO
    socket.on('bloque_minado', (data) => {
        console.log(`‚õèÔ∏è BLOQUE #${data.index} MINADO!`);
        // Simulamos clics para refrescar la pantalla
        document.getElementById('btnBalances').click();
        document.getElementById('btnLeaders').click();
        document.getElementById('btnChain').click();
        document.getElementById('btnShowMempool').click();
        
        // Efecto visual en el badge
        const b = document.getElementById('statusBadge');
        b.textContent = `¬°NUEVO BLOQUE #${data.index}!`;
        b.style.backgroundColor = '#10b981';
        b.style.color = 'black';
        setTimeout(() => setBadge(true, '(EN VIVO)'), 3000);
    });
    // --- FIN C√ìDIGO WEBSOCKETS ---

    let aliasCache = {}; 
    let reverseAliasCache = {}; 
    
    const stableStringify = (v) => {
      if (v === null || typeof v !== 'object') return JSON.stringify(v);
      if (Array.isArray(v)) return '[' + v.map(stableStringify).join(',') + ']';
      const keys = Object.keys(v).sort();
      return '{' + keys.map(k => JSON.stringify(k)+':'+stableStringify(v[k])).join(',') + '}';
    };

    const hashPayload = (payload) => {
        const payloadCopy = { ...payload };
        delete payloadCopy.signature;
        const s = stableStringify(payloadCopy);
        return sha256(s);
    };

    const generateKeyPair = () => {
        const key = ec.genKeyPair();
        const privateKeyHex = key.getPrivate('hex');
        const publicKeyHex = key.getPublic('hex'); 
        return { privateKeyHex, publicKeyHex };
    };

    const signTransaction = (privateKeyHex, payload) => {
        try {
            const key = ec.keyFromPrivate(privateKeyHex, 'hex');
            const payloadHash = hashPayload(payload);
            const signature = key.sign(payloadHash, 'hex');
            return signature.toDER('hex'); 
        } catch (e) {
            console.error("Error signing:", e);
            return "";
        }
    };
    
    const pubToAddress = (publicKeyHex) => {
        if (!publicKeyHex) return "";
        
        // Casos especiales del sistema
        if (publicKeyHex === 'SYSTEM') return '‚öôÔ∏è SYSTEM';
        
        // 1. Buscar si tiene Alias
        const alias = reverseAliasCache[publicKeyHex];
        
        // 2. Recortar la llave (Primeros 8..√öltimos 6)
        const shortKey = publicKeyHex.substring(0, 10) + '...' + publicKeyHex.substring(publicKeyHex.length - 6);

        // 3. L√ìGICA VISUAL:
        if (alias) {
            // Si es el Founder
            if (alias.includes("FOUNDER")) {
                return `<span style="color:#fcd34d; font-weight:bold;">${alias}</span> <code style="opacity:0.7; font-size:0.9em">(${shortKey})</code>`;
            }
            
            // Usuario normal: Muestra "Alias (Llave...)"
            return `<span style="color:#4ade80; font-weight:bold;">${alias}</span> <code style="opacity:0.7; font-size:0.9em">(${shortKey})</code>`;
        }
        
        // Si no tiene alias, solo muestra la llave
        return `<code style="opacity:0.8">${shortKey}</code>`;
    };

    const log = (obj, title) => {
      const el = document.getElementById('log');
      const prev = el.innerHTML;
      const now = `<pre><code>${title ? '‚ñ∂ ' + title + '\n' : ''}${typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2)}</code></pre>`;
      el.innerHTML = now + '\n' + prev;
    };
    const setBadge = (ok, extra='') => {
      const b = document.getElementById('statusBadge');
      if (ok) { b.textContent = 'Status: OK ' + extra; b.style.color = '#86efac'; }
      else { b.textContent = 'Status: ERROR ' + extra; b.style.color = '#fca5a5'; }
    };
    const api = (path, opts={}) =>
      fetch(path, { headers: { 'Content-Type':'application/json' }, ...opts })
        .then(async r => {
          const data = await r.json().catch(()=>({raw:'(sin JSON)'}));
          if (!r.ok) throw { status: r.status, data };
          return data;
        });
        
    const updateAliasCaches = async () => {
        try {
            const data = await api('/aliases');
            aliasCache = data;
            reverseAliasCache = {}; 
            for (const [alias, pubkey] of Object.entries(data)) {
                reverseAliasCache[pubkey] = alias;
            }
            log(aliasCache, 'Alias Sincronizados');
        } catch (e) {
            log(e, 'ERROR /aliases');
        }
    };
        
    const renderTable = (title, dataObj, containerId, valueLabel='Valor') => {
      const container = document.getElementById(containerId);
      const entries = Object.entries(dataObj || {});
      if (!entries.length) {
        container.innerHTML = `<div class="muted">Sin datos por ahora.</div>`;
        return;
      }
      const rows = entries
        .map(([k,v],i) => {
            const displayValue = Number(v); 
            const displayName = pubToAddress(k);
            return `
              <tr>
                <td style="width:56px;">#${i+1}</td>
                <td><code>${displayName}</code></td>
                <td style="text-align:right">${displayValue}</td>
              </tr>
            `;
        }).join('');
      container.innerHTML = `
        <div class="muted" style="margin:6px 0 8px 0;">${title}</div>
        <table class="table">
          <thead>
            <tr><th>#</th><th>Address (Alias / Public Key)</th><th style="text-align:right">${valueLabel}</th></tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    };

    const renderMempool = (transactions, containerId='mempoolResults') => {
      const container = document.getElementById(containerId);
      if (transactions.length === 0) {
        container.innerHTML = '<div class="mempool-empty">El Mempool est√° vac√≠o.</div>';
        return;
      }

      const rows = transactions.map((tx, i) => {
        const displayAmount = Number(tx.amount);
        const senderName = pubToAddress(tx.sender);
        const recipientName = pubToAddress(tx.recipient);
        const time = tx.timestamp ? new Date(tx.timestamp * 1000).toLocaleTimeString() : 'N/A';

        return `
            <tr>
                <td style="width: 30px;">#${i + 1}</td>
                <td style="width: 100px; text-align:right;">${displayAmount}</td>
                <td><code>${senderName}</code></td>
                <td><code>${recipientName}</code></td>
                <td>${time}</td>
            </tr>
        `;
      }).join('');

      container.innerHTML = `
            <table class="table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th style="text-align:right;">Monto</th>
                        <th>Remitente</th>
                        <th>Destinatario</th>
                        <th>Hora</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        `;
    };
    
    let lastVerifiedTransaction = null; 

    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    }

    function updateScrollProgress() {
      const scrollProgress = document.querySelector('.scroll-progress');
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
      const scrollPercent = (scrollTop / scrollHeight) * 100;
      scrollProgress.style.width = scrollPercent + '%';
    }

    function updateScrollToTopButton() {
      const scrollBtn = document.querySelector('.scroll-to-top');
      if (window.pageYOffset > 300) {
        scrollBtn.classList.add('visible');
      } else {
        scrollBtn.classList.remove('visible');
      }
    }

    function scrollToTop() {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }

    window.addEventListener('load', () => {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);

        document.querySelector('.theme-toggle').addEventListener('click', toggleTheme);

        window.addEventListener('scroll', () => {
          updateScrollProgress();
          updateScrollToTopButton();
        });

        document.querySelector('.scroll-to-top').addEventListener('click', scrollToTop);
        
        document.getElementById('btnRandomKeys').onclick = async () => {
            const alias = document.getElementById('alias').value;
            if (!alias) {
                log("ERROR: Debes escribir un Alias (nombre) para registrar.", 'Error de Registro');
                return;
            }
            
            log("Generando llaves y registrando alias...");
            const { privateKeyHex, publicKeyHex } = generateKeyPair();
            if (!privateKeyHex || !publicKeyHex) { 
                log("ERROR: La generaci√≥n de claves fall√≥.", 'Error de Criptograf√≠a');
                return;
            }
            
            document.getElementById('privateKey').value = privateKeyHex;
            document.getElementById('publicKey').value = publicKeyHex;
            document.getElementById('sender_pub_tx').value = publicKeyHex; 
            document.getElementById('miner_address').value = publicKeyHex; 
            log({ alias, privateKeyHex, publicKeyHex }, 'Llaves Generadas');
            
            try {
                const regData = await api('/register_alias', {
                    method: 'POST',
                    body: JSON.stringify({ alias: alias, public_key: publicKeyHex })
                });
                log(regData, 'Alias Registrado');
                await updateAliasCaches();
                document.getElementById('btnBalances').click();
            } catch (e) {
                log(e.data, 'ERROR de Registro de Alias');
            }
            
            document.getElementById('signature_node').value = '';
            document.getElementById('publickey_node').value = '';
            document.getElementById('btnSendToMempool').disabled = true;
            document.getElementById('validationCard').classList.remove('valid', 'invalid');
            lastVerifiedTransaction = null;
        };

        document.getElementById('btnSignTx').onclick = () => {
            const privateKeyHex = document.getElementById('privateKey').value;
            const senderPub = document.getElementById('sender_pub_tx').value;
            let recipient = document.getElementById('recipient_tx').value;
            
            const amount_input = parseFloat(document.getElementById('amount_tx').value || '0');
            const amount_int = Math.round(amount_input); 

            if (!privateKeyHex || !senderPub) {
                log("ERROR: Debes generar y seleccionar las Llaves primero.", 'Error de Firma');
                return;
            }
            
            if (recipient && !recipient.startsWith('04')) {
                const resolvedKey = aliasCache[recipient];
                if (resolvedKey) {
                    log(`Alias "${recipient}" resuelto a ${resolvedKey.substring(0, 20)}...`);
                    recipient = resolvedKey;
                } else {
                    log(`ERROR: Alias "${recipient}" no encontrado.`, 'Error de Firma');
                    return;
                }
            }
            
            if (!recipient || amount_int <= 0) {
                log("ERROR: Monto debe ser positivo y Destinatario (o alias) v√°lido.", 'Error de Firma');
                return;
            }

            const payload = {
                amount: amount_int, 
                recipient: recipient, 
                sender: senderPub,
            };
            
            const signature = signTransaction(privateKeyHex, payload);
            document.getElementById('signature_tx').value = signature;
            log({ payload, signature, hash: hashPayload(payload) }, 'Transacci√≥n Firmada');

            document.getElementById('signature_node').value = signature;
            document.getElementById('publickey_node').value = senderPub;
            document.getElementById('btnSendToMempool').disabled = true; 
            document.getElementById('validationCard').classList.remove('valid', 'invalid');
            lastVerifiedTransaction = null;
        };
        
        const validationCard = document.getElementById('validationCard');
        const btnSendToMempool = document.getElementById('btnSendToMempool');
        btnSendToMempool.disabled = true; 

        document.getElementById('btnVerifyTxNode').onclick = async () => {
            const sender_pub = document.getElementById('sender_pub_tx').value;
            let recipient = document.getElementById('recipient_tx').value;
            
            const amount_input = parseFloat(document.getElementById('amount_tx').value || '0');
            const amount_int = Math.round(amount_input);

            const signature = document.getElementById('signature_node').value;
            const publickey_for_verification = document.getElementById('publickey_node').value;

            if (recipient && !recipient.startsWith('04')) {
                const resolvedKey = aliasCache[recipient];
                if (resolvedKey) {
                    log(`Alias "${recipient}" resuelto a ${resolvedKey.substring(0, 20)}...`);
                    recipient = resolvedKey;
                } else {
                    log(`ERROR: Alias "${recipient}" no encontrado.`, 'Error de Verificaci√≥n');
                    validationCard.classList.add('invalid');
                    return;
                }
            }

            if (!sender_pub || !signature || !recipient || amount_int <= 0 || !publickey_for_verification) {
                log("ERROR: Rellenar todos los campos de Tx, Public Key y Firma.", 'Error de Verificaci√≥n');
                validationCard.classList.remove('valid');
                validationCard.classList.add('invalid');
                btnSendToMempool.disabled = true;
                return;
            }

            try {
                const verificationResult = await api('/transactions/verify_only', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        sender_pub: publickey_for_verification, 
                        recipient: recipient,
                        amount: amount_int,
                        signature: signature,
                    })
                });

                if (verificationResult && verificationResult.valid) {
                    log("VERIFICACI√ìN EXITOSA (BACKEND): Firma v√°lida y fondos suficientes.", 'Verificaci√≥n Exitosa');
                    validationCard.classList.remove('invalid');
                    validationCard.classList.add('valid');
                    btnSendToMempool.disabled = false;
                    lastVerifiedTransaction = { sender_pub: publickey_for_verification, recipient, amount: amount_int, signature: signature };

                } else {
                    log(verificationResult.error || "VERIFICACI√ìN FALLIDA: Fondos insuficientes o error en el backend.", 'Verificaci√≥n Fallida');
                    validationCard.classList.remove('valid');
                    validationCard.classList.add('invalid');
                    btnSendToMempool.disabled = true;
                }

            } catch (e) {
                log(e.data?.error || "VERIFICACI√ìN FALLIDA: Error al comunicarse con el nodo.", 'Verificaci√≥n Fallida');
                validationCard.classList.remove('valid');
                validationCard.classList.add('invalid');
                btnSendToMempool.disabled = true;
            }
        };

        document.getElementById('btnSendToMempool').onclick = async () => {
            if (!lastVerifiedTransaction) {
                log("ERROR: Primero debes verificar la transacci√≥n.", 'Error de Env√≠o');
                return;
            }
            
            try { 
                const d = await api('/transactions/new', { 
                    method:'POST', 
                    body: JSON.stringify(lastVerifiedTransaction) 
                }); 
                log(d, 'Transacci√≥n A√±adida al Mempool');
                document.getElementById('btnShowMempool').click();
                document.getElementById('btnBalances').click();
                
                btnSendToMempool.disabled = true;
                validationCard.classList.remove('valid', 'invalid');
                lastVerifiedTransaction = null;

            } catch (e) { 
                log(e, 'ERROR al enviar al Mempool'); 
                document.getElementById('btnBalances').click();
            }
        };

        document.getElementById('btnMine').onclick = async () => {
            const miner_address = document.getElementById('miner_address').value;
            if (!miner_address) {
                log("ERROR: La direcci√≥n del minero no puede estar vac√≠a.", 'Error de Minado');
                return;
            }
            const t0 = performance.now();
            try { 
                const d = await api('/mine', { method:'POST', body: JSON.stringify({ miner_address }) }); 
                const t1 = performance.now(); 
                log({ tiempo_ms: Math.round(t1-t0), ...d }, 'Bloque Minado'); 

                document.getElementById('blockIndex').textContent = d.index;
                document.getElementById('blockNonce').textContent = d.nonce;
                document.getElementById('blockPrevHash').textContent = d.previous_hash;
                document.getElementById('blockHash').textContent = d.hash;

                const txListEl = document.getElementById('blockTxsList');
                if (d.transactions && d.transactions.length > 0) {
                    txListEl.innerHTML = d.transactions.map((tx, i) => 
                        `<p class="muted" style="font-size:11px; margin: 4px 0;">
                            <b>Tx #${i}:</b> ${tx.amount} 
                            (De: ${pubToAddress(tx.sender)} 
                            -> A: ${pubToAddress(tx.recipient)})
                        </p>`
                    ).join('');
                } else {
                    txListEl.innerHTML = '<p class="muted">No hay transacciones en este bloque.</p>';
                }

                document.getElementById('btnChain').click();
                document.getElementById('btnLeaders').click();
                document.getElementById('btnBalances').click();
                document.getElementById('btnShowMempool').click(); 

            } catch (e) { 
                log(e, 'ERROR /mine'); 
            }
        };

        document.getElementById('btnHealth').onclick = async () => {
          try { const d = await api('/health'); setBadge(true, `(diff=${d.difficulty})`); log(d, '/health'); }
          catch (e) { setBadge(false); log(e, 'ERROR /health'); }
        };
        document.getElementById('btnChain').onclick = async () => { try { log(await api('/chain'), '/chain'); } catch(e){ log(e,'ERROR /chain'); } };
        document.getElementById('btnValidate').onclick = async () => { try { log(await api('/validate'), '/validate'); } catch(e){ log(e,'ERROR /validate'); } };
        
        document.getElementById('btnLeaders').onclick = async () => {
          try { 
            await updateAliasCaches();
            const d = await api('/leaders');
            log(d, '/leaders (Ranking)');                 
            renderTable('Recompensas acumuladas por minero', d, 'leadersTable', 'Recompensa');
          } catch (e) { log(e, 'ERROR /leaders'); }
        };
        document.getElementById('btnBalances').onclick = async () => {
          try { 
            await updateAliasCaches();
            const d = await api('/balances');
            log(d, '/balances (Saldos)');
            renderTable('Saldo neto por address (Public Key)', d, 'balancesTable', 'Saldo');
          } catch (e) { log(e, 'ERROR /balances'); }
        };
        document.getElementById('btnShowMempool').onclick = async () => { 
            try { 
                await updateAliasCaches();
                const d = await api('/mempool'); 
                renderMempool(d, 'mempoolResults'); 
                log(d, '/mempool (Transacciones Pendientes)'); 
            } catch(e) { log(e,'ERROR /mempool'); } 
        };

        document.getElementById('btn_faucet_send').onclick = async () => {
            const recipient = document.getElementById('faucet_recipient').value;
            const private_key = document.getElementById('faucet_private_key').value;
            let recipient_address = recipient;

            if (!recipient_address || !private_key) {
                log("ERROR: Debes poner un Destinatario Y la Llave Privada del Fundador.", 'Error de Faucet');
                return;
            }

            if (!recipient_address.startsWith('04')) {
                const resolvedKey = aliasCache[recipient_address];
                if (resolvedKey) {
                    log(`Alias "${recipient_address}" resuelto a ${resolvedKey.substring(0, 20)}...`);
                    recipient_address = resolvedKey;
                } else {
                    log(`ERROR: Alias "${recipient_address}" no encontrado.`, 'Error de Faucet');
                    return;
                }
            }
            
            log(`Enviando 100 monedas del Faucet a ${pubToAddress(recipient_address)}...`);
            try {
                const d = await api('/faucet', { 
                    method:'POST', 
                    body: JSON.stringify({ 
                        recipient_address: recipient_address,
                        admin_private_key: private_key
                    }) 
                });
                log(d, 'Faucet');
                document.getElementById('btnShowMempool').click();
                document.getElementById('btnBalances').click();
            } catch (e) {
                log(e.data, 'ERROR /faucet');
            }
        };

        const init = async () => {
            await updateAliasCaches();
            document.getElementById('btnHealth').click();
            document.getElementById('btnBalances').click();
        };
        init();
    });
  </script>
</head>
<body>
  <div class="scroll-progress"></div>
  <div class="cosmic-background"></div>
  <div class="nebula-effect"></div>
  <div class="particles" id="particles"></div>

  <header>
    <div class="header-content">
      <div>
        <div style="display: flex; align-items: center; gap: 12px;">
          <div class="logo">‚Çø</div>
          <h1>Blockchain Simulator</h1>
          <span class="badge" id="statusBadge">Status: ...</span>
        </div>
        <div class="subtitle">Sistema descentralizado con ECDSA y Proof of Work</div>
      </div>
      <button class="theme-toggle" aria-label="Toggle theme">
        <div class="theme-toggle-slider">üåô</div>
      </button>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>Generaci√≥n de Identidad</h2>
      
      <label>Alias (Tu nombre de usuario)</label>
      <input id="alias" placeholder="Ej: victor, satoshi, ..." />
      <div style="height:10px"></div>
      
      <label>Llave Privada (Private Key - ¬°Secreta!)</label>
      <input id="privateKey" placeholder="Se generar√° al registrar el alias..." readonly/>
      <div style="height:10px"></div>
      <label>Llave P√∫blica (Public Key - Direcci√≥n)</label>
      <textarea id="publicKey" rows="3" placeholder="Se generar√° al registrar el alias..." readonly></textarea>
      <div style="height:10px"></div>
      
      <button class="btn primary" id="btnRandomKeys">GENERAR Y REGISTRAR ALIAS</button>
      
    </section>

    <section class="card">
      <h2>Creaci√≥n y Firma de Transacci√≥n</h2>
      <label>Remitente (sender_pub - Copia la Public Key de arriba)</label>
      <textarea id="sender_pub_tx" rows="2" placeholder="Llave P√∫blica COMPLETA del remitente (FROM)"></textarea>
      <div style="height:10px"></div>
      
      <label>Destinatario (recipient)</label>
      <input id="recipient_tx" placeholder="Alias o Llave P√∫blica de otro usuario (TO)" value="04634f590b074a123f81e3630f146a066c06173a144e54e4c9c221191060934e6284f1b4a558509c2a8c3d706f9d34346747530e7d0263f10646c8a513511111" />
      <div style="height:10px"></div>
      
      <label>Monto (amount)</label>
      <input id="amount_tx" type="number" step="1" placeholder="10" value="10" /> 
      
      <div style="height:10px"></div>
      <button class="btn" id="btnSignTx">FIRMAR TRANSACCI√ìN</button>
      <div style="height:10px"></div>
      <label>Firma de Transacci√≥n (Message Signature)</label>
      <textarea id="signature_tx" rows="2" placeholder="Se genera al firmar el payload..."></textarea>
    </section>

    <section class="card validation-card" id="validationCard">
      <h2>Verificaci√≥n de Firma y Fondos</h2>
      <div class="muted">
        El Nodo Central verifica la autenticidad (firma) y la disponibilidad de fondos antes de aceptar una transacci√≥n.
      </div>
      <div style="height:16px"></div>

      <label>Firma del Mensaje (Message Signature)</label>
      <textarea id="signature_node" rows="2" placeholder="Copia la firma de la secci√≥n anterior"></textarea>
      <div style="height:10px"></div>
      <label>Llave P√∫blica del Remitente (Public Key)</label>
      <textarea id="publickey_node" rows="2" placeholder="Copia la Public Key del Remitente"></textarea>
      <div style="height:10px"></div>

      <div class="row">
          <button class="btn" id="btnVerifyTxNode">VERIFICAR</button>
          <button class="btn primary" id="btnSendToMempool">ENVIAR AL MEMPOOL</button>
      </div>
    </section>
    
    <div class="card col-span-3" style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; padding: 24px;">
        
        <div class="card" style="margin: 0; padding: 20px;">
            <h2>Mempool - Transacciones Pendientes</h2>
            <div class="muted" style="margin-bottom: 12px;">
                Transacciones v√°lidas esperando ser incluidas en el pr√≥ximo bloque por un minero.
            </div>
            <button class="btn" id="btnShowMempool">VER MEMPOOL ACTUAL</button>
            <div style="margin-top: 15px;">
                <div id="mempoolResults">
                    <div class="muted">Haz clic en "Ver Mempool Actual" para ver transacciones pendientes.</div>
                </div>
            </div>
        </div>

        <div class="card" style="margin: 0; padding: 20px;">
            <h2>Proceso de Minado</h2>
            <label>Direcci√≥n del minero (Alias o Public Key)</label>
            <textarea id="miner_address" rows="2" placeholder="Pega aqu√≠ tu Alias o Public Key para recibir la recompensa..."></textarea>
            <div style="height:10px"></div>
            <button class="btn primary" id="btnMine">MINAR BLOQUE (PoW)</button>
            <div style="height:20px"></div>

            <h3>Bloque Candidato (Resultado)</h3>
            <div class="muted">
                Haz clic en MINAR para calcular el hash del siguiente bloque.
            </div>
            
            <div id="blockCandidateDisplay" class="block-display">
                <p><strong>Bloque N¬∞:</strong> <span id="blockIndex">...</span></p>
                <p><strong>Nonce encontrado:</strong> <span id="blockNonce">...</span></p>
                <p><strong>Prev Hash:</strong> <code id="blockPrevHash">...</code></p>
                <hr>
                <h4>Transacciones (Mempool incluido):</h4>
                <div id="blockTxsList">
                    <p class="muted">Carga el Mempool para ver el contenido a minar.</p>
                </div>
                <hr>
                <p><strong>HASH V√ÅLIDO:</strong> <code id="blockHash">...</code></p>
            </div>
        </div>
    </div>

    <section class="card col-span-3">
      <h2>Resumen Econ√≥mico (Validado por la Cadena)</h2>
      <div class="row">
        <div><div id="leadersTable"></div></div>
        <div><div id="balancesTable"></div></div>
      </div>
    </section>
    
    <section class="card col-span-3">
      <h2>Panel de Resultados / Log</h2>
      <div class="log" id="log"></div>
    </section>

    <section class="card col-span-3 faucet-card">
        <h2>Faucet del Fundador (Admin)</h2>
        <div class="muted">
          Aqu√≠ el Fundador puede "empujar" fondos a cualquier usuario.
          (Necesitas la Llave Privada del Fundador que se muestra en la consola del servidor).
        </div>
        <div style="height:16px"></div>
  
        <label>Destinatario (Alias o Llave P√∫blica)</label>
        <input id="faucet_recipient" placeholder="Ej: victor (o la llave 04...)" />
        <div style="height:10px"></div>

        <!-- Llave Privada del Fundador -->
        <label>Llave Privada del Fundador (Admin)</label>
        <textarea id="faucet_private_key" rows="2" readonly style="opacity: 0.7;">84a1dad2fa1c17c90d67c28a7f2dc49634ee15bf0e22c02ced1209cebbbb8d7d</textarea>
        <div style="height:10px"></div>
        
        <button class="btn" id="btn_faucet_send">
            ENVIAR 100 (desde Fundador)
        </button>
    </section>

    <section class="card col-span-3">
      <h2>Consultas de Cadena</h2>
      <div class="grid-4">
        <button class="btn" id="btnHealth">/HEALTH</button>
        <button class="btn" id="btnChain">/CHAIN</button>
        <button class="btn" id="btnValidate">/VALIDATE</button>
        <button class="btn" id="btnLeaders">/LEADERS</button>
        <button class="btn" id="btnBalances">/BALANCES</button>
      </div>
    </section>
  </main>

  <button class="scroll-to-top" aria-label="Scroll to top">‚Üë</button>

  <div class="footer">Blockchain Simulator con ECDSA y Proof of Work - Requiere Flask backend</div>
</body>
</html>
